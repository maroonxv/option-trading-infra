# 2026-01-28 策略回测与实盘差异及性能优化分析

在对波动率策略进行代码审计后，发现了以下几个关键问题，这些问题直接影响实盘的稳定性、性能以及回测的真实性。

## 1. 监控快照（Pickle）性能与膨胀问题

### 问题描述
- **回测 IO 冗余**：策略在回测模式下，每一根 K 线更新都会触发 `_dump_snapshot`。这导致了海量的磁盘 IO 操作，严重拖慢回测速度，且回测中实时更新监控快照并无实际意义。
- **内存泄漏与文件膨胀**：`TargetInstrument` 实体在 `append_bar` 时仅执行 `pd.concat`，没有任何长度限制。长期运行会导致 `self.bars` 无限增长，占用大量内存，并导致生成的 `.pkl` 文件越来越大。

### 解决方案
- **回测屏蔽**：在 `VolatilityTrade` 的 `_dump_snapshot` 方法中增加判断，如果处于回测模式则直接跳过磁盘写入。
- **数据裁剪（Trimming）**：在 `TargetInstrument.append_bar` 中增加逻辑，仅保留最近 N 根（如 2000 根）K 线，确保内存消耗和磁盘占用恒定。

## 2. 实盘状态持久化策略优化

### 问题描述
- **过度依赖 Pickle**：目前实盘重启后尝试从 Pickle 恢复所有状态（包括行情数据）。如果 Pickle 文件损坏或版本不兼容，会导致策略无法启动。
- **状态分类不明确**：行情衍生的指标（如 MACD）可以通过数据库重放得到，而业务状态（如日内开仓限额）则无法通过数据库恢复。

### 解决方案
- **混合持久化**：
    - **行情数据**：重启时通过 `load_bar` 从数据库加载历史数据并重新计算指标，不再依赖持久化文件。
    - **业务状态**：仅将 `daily_open_count_map`、`global_daily_open_count` 等核心业务变量存入 Pickle 或 JSON。
- **健壮性增强**：增加异常捕获，确保即便持久化文件加载失败，策略也能通过数据库初始化（仅丢失当日计数）。

## 3. 回测与实盘的核心逻辑差异：Tick 缺失

### 问题描述
- **虚假的流动性**：`VnpyMarketDataGateway` 在回测模式下伪造了完美的 Tick 数据（`bid_volume` 为 1000，`spread` 为 0）。
- **逻辑失效**：这导致 `OptionSelectorService.check_liquidity` 筛选逻辑在回测中形同虚设，所有合约都能通过流动性检查，严重高估了期权的成交能力和价格优势。

### 解决方案
- **精细化 Mock**：修改回测网关，不再提供“完美”数据。可以根据配置引入随机滑点模拟或基于历史成交量（Volume）按比例映射买一量。
- **合约属性修正**：修正回测中 `size` 和 `pricetick` 统一硬编码的问题，建立基于品种的字典，确保滑点和盈亏计算在回测中真实有效。

## 4. 后续任务单
- [ ] 修改 `VolatilityTrade` 跳过回测时的 snapshot。
- [ ] 修改 `TargetInstrument` 增加 K 线长度限制逻辑。
- [ ] 优化 `VnpyMarketDataGateway` 的回测 Mock 逻辑。
- [ ] 完善 `VtSymbolGenerator` 中的合约属性字典（Size/Pricetick）。
