# 2024年12月24日代码审查问题汇总

经过对策略代码（特别是持仓管理和交易执行部分）的详细审查，发现以下关键问题，需紧急修复。

## 1. 致命问题：期权行情获取与筛选逻辑矛盾

*   **位置**: `src/strategy/application/volatility_trade.py` -> `_get_option_contracts`
*   **问题描述**: 代码在获取期权合约信息时，手动将 `bid_price` 和 `bid_volume` 硬编码为 0。
    ```python
    option_data.append({
        # ...
        "bid_price": 0,  # <--- 硬编码为 0
        "bid_volume": 0,
        # ...
    })
    ```
    然而，`OptionSelectorService` 默认配置了流动性过滤：
    ```python
    DEFAULT_MIN_BID_PRICE = 10.0
    # ...
    result = result[result["bid_price"] >= self.min_bid_price]
    ```
*   **后果**: 策略 **永远无法选出可交易的期权合约**，因为所有合约都会因价格为 0 被过滤掉。
*   **修复方案**: 在 `_get_option_contracts` 中，需要通过 `self.strategy_context.get_tick(vt_symbol)` 或类似接口获取实时的快照数据来填充 `bid_price` 和 `ask_price`。

## 2. 严重问题：缺失动态行情订阅

*   **位置**: `src/strategy/application/volatility_trade.py`
*   **问题描述**: 策略初始化时只订阅了标的期货。当 `_check_and_execute_open` 选中并买入/卖出一个期权合约后，**没有调用 `subscribe`**。
*   **后果**:
    1. VnPy 不会推送该期权的实时数据。
    2. 策略无法更新持仓市值，盈亏计算错误。
    3. 如果平仓逻辑依赖期权最新价格，将无法执行。
*   **修复方案**: 在执行开仓动作后，立即调用 `self.strategy_context.subscribe(option_vt_symbol)`。

## 3. 严重问题：重启后持仓状态丢失

*   **位置**: `src/strategy/application/volatility_trade.py` -> `__init__`
*   **问题描述**: `VolatilityTrade` 初始化时创建了空的 `PositionAggregate`，但没有从底层同步已有的实际持仓。
*   **后果**: 策略重启后会认为自己是 **空仓**。这将导致：
    1. 忽略老持仓，无法对其进行平仓管理（失控）。
    2. 可能会重复开仓，超出 `max_positions` 限制。
*   **修复方案**: 在 `VolatilityTrade` 初始化后（或 `on_init` 阶段），遍历 `self.account_gateway.get_all_positions()`，将属于本策略的持仓“重建”到 `PositionAggregate` 中。

## 4. 风险问题：期权市价单平仓

*   **位置**: `src/strategy/application/volatility_trade.py` -> `_check_and_execute_close`
*   **问题描述**: 平仓时使用 `close_price=0`，在 VnPy 中通常意味着市价单。
*   **后果**: 期权流动性通常较差，市价单极易遭遇 **巨额滑点**，甚至成交在钓鱼价。
*   **修复方案**:
    1. 获取期权当前的对手价（买一/卖一）。
    2. 发送带有一定滑点的 **限价单** (Limit Order)。

## 5. 逻辑细节：资金使用率计算未考虑未成交单

*   **位置**: `src/strategy/domain/domain_service/position_sizing_service.py`
*   **问题描述**: `make_open_decision` 直接使用 `account_balance * ratio` 计算手数。
*   **后果**: 如果多标的同时触发信号，或者短时间内连续触发，由于前一笔订单尚未成交/扣款，余额未变，会导致总资金占用超出预期。
*   **修复方案**: 计算可用资金时，应扣除 `PositionAggregate` 中记录的“待成交订单预估保证金”或已占用的名义本金。
