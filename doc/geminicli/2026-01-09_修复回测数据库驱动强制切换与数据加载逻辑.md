# 2026-01-09 修复回测数据库驱动强制切换与数据加载逻辑

## 1. 问题描述
在运行 `src/backtesting/run_backtesting.py` 时，发现回测引擎加载的数据量始终为 0。

**诊断发现：**
- **驱动回退**：尽管注入了 MySQL 配置，VnPy 的 `BacktestingEngine` 在内部初始化时仍通过工厂函数 `get_database()` 获取到了默认的 `SqliteDatabase`。
- **表名不匹配**：MySQL 中实际存储数据的表名为 `dbbardata`，而 `vnpy_mysql` 默认寻找 `db_bar_data`。
- **符号错误**：郑商所 (CZCE) 的合约代码在数据库中以 3 位数字（如 `AP601`）存储，而原脚本生成的是 4 位数字（如 `AP2601`）。

## 2. 解决方案

### 2.1 强制数据库驱动补丁 (Monkey Patch)
由于 VnPy 内部模块加载顺序的原因，传统的配置注入无法 100% 保证驱动不回退。采取了“暴力”补丁方案：
- 替换 `vnpy.trader.database.get_database` 函数。
- 强制该函数返回 `vnpy_mysql.Database` 实例。
- 实现**单例模式**，缓存数据库实例，防止 Peewee 抛出 `Connection already opened` 异常。

### 2.2 数据库表名适配
在强制初始化 MySQL 驱动时，通过修改 `vnpy_mysql.mysql_database.DbBarData._meta.table_name` 将表名指向实际存在的 `dbbardata`。

### 2.3 郑商所符号逻辑修正
更新 `src/backtesting/vt_symbol_generator.py`，针对 `CZCE` 交易所，将年份从 4 位截断为 1 位（例如 2026 年变为 `6`），生成符合数据库存储规范的 `AP601` 等符号。

## 3. 实施效果
- **数据库连接**：成功强制回测引擎连接到 `localhost:3306` 的 MySQL。
- **数据加载**：日志确认 `ag2601.SHFE` 加载 2387 条数据，`AP601.CZCE` 加载 551 条数据。
- **引擎状态**：回测流程顺利进入 `on_bars` 循环。

## 4. 遗留待办
- **AttributeError**：回测运行中发现 `indicator_service.py` 尝试访问 `EMAState.ema_fast` 属性失败，需确认 `EMAState` 定义并修正属性名。
- **清理调试日志**：回测稳定后需关闭 Peewee 的 SQL 调试日志以提升性能。